import{a as Z,l as ee,r as l,s as w,j as e,H as k,M as R,B as d}from"./index-CmGxKR2W.js";import{C as N,a as v,b,c as C,d as y,e as se}from"./ChatWindow-CAKZhwK9.js";import{L as ae,I as O,D as te,a as le,b as ie,c as ne,d as re}from"./dialog-x9vYFAAS.js";const P=4,_=10,de=.1,oe=.05,ue=()=>{const{currentUser:i,allUsers:S,isLoading:$,isLoadingUsers:U,exchangeRate:u,setExchangeRate:M}=Z(),{contracts:o,resolveDispute:h}=ee(),[n,z]=l.useState(""),[T,H]=l.useState(P),[I,q]=l.useState(P),[D,L]=l.useState(u.toFixed(2)),[A,E]=l.useState(!1),[g,B]=l.useState(null);l.useEffect(()=>{L(u.toFixed(2))},[u]);const r=l.useMemo(()=>{const s=new Map;return S.forEach(a=>s.set(a.id,a)),s},[S]),G=l.useMemo(()=>o.reduce((s,a)=>a.clientDeposited&&(a.status==="active"||a.status==="disputed")?s+a.serviceRate:s,0),[o]),V=l.useMemo(()=>o.reduce((s,a)=>{let t=0;return a.clientDeposited&&(t+=a.serviceRate*oe),(a.status==="finalized"||a.status==="finalized_by_dispute"&&a.disputeResolution==="toProvider")&&(t+=a.serviceRate*de),s+t},0),[o]),p=l.useMemo(()=>{const s=n.toLowerCase();return o.filter(a=>{var t,c;return(a.status==="disputed"||a.status==="finalized_by_dispute")&&(a.serviceTitle.toLowerCase().includes(s)||(((t=r.get(a.clientId))==null?void 0:t.name.toLowerCase())||"").includes(s)||(((c=r.get(a.providerId))==null?void 0:c.name.toLowerCase())||"").includes(s))})},[o,n,r]),j=l.useMemo(()=>{let s=p.filter(a=>a.status==="disputed");return s.sort((a,t)=>t.createdAt-a.createdAt),s},[p]),f=l.useMemo(()=>{let s=p.filter(a=>a.status==="finalized_by_dispute");return s.sort((a,t)=>t.updatedAt-a.updatedAt),s},[p]),x=l.useMemo(()=>j.slice(0,T),[j,T]),m=l.useMemo(()=>f.slice(0,I),[f,I]),W=l.useCallback(()=>{H(s=>s+_)},[]),Y=l.useCallback(()=>{q(s=>s+_)},[]),J=l.useCallback(async s=>{(i==null?void 0:i.type)==="admin"?await h(s.id,"toProvider"):w("Solo un administrador puede resolver disputas.")},[i,h]),K=l.useCallback(async s=>{(i==null?void 0:i.type)==="admin"?await h(s.id,"toClient"):w("Solo un administrador puede resolver disputas.")},[i,h]),Q=l.useCallback(async()=>{const s=parseFloat(D);if(isNaN(s)||s<=0){w("Por favor, introduce un monto válido y positivo para la tasa de cambio.");return}await M(s)},[D,M]),F=l.useCallback(s=>{B(s),E(!0)},[]);return $||U?e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(k,{}),e.jsx("div",{className:"flex-grow flex items-center justify-center bg-gray-100 dark:bg-gray-900 p-4",children:e.jsx("div",{className:"text-center p-4",children:e.jsx("h1",{className:"text-4xl font-bold mb-4 text-gray-800 dark:text-gray-100",children:"Cargando información..."})})}),e.jsx(R,{})]}):(i==null?void 0:i.type)!=="admin"?e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(k,{}),e.jsx("div",{className:"flex-grow flex items-center justify-center bg-gray-100 dark:bg-gray-900 p-4",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("h1",{className:"text-4xl font-bold mb-4 text-gray-800 dark:text-gray-100",children:"Acceso Denegado"}),e.jsx("p",{className:"text-xl text-gray-600 dark:text-gray-300",children:"Solo los administradores pueden acceder a este panel."})]})}),e.jsx(R,{})]}):e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(k,{}),e.jsx("div",{className:"flex-grow flex flex-col items-center bg-gray-100 dark:bg-gray-900 p-4",children:e.jsxs("div",{className:"w-full max-w-4xl bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md text-gray-800 dark:text-gray-100 mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6 text-center",children:"Panel de Administración"}),e.jsx("p",{className:"text-xl text-gray-600 dark:text-gray-300 text-center mb-8",children:"Gestiona los contratos en disputa y revisa las resoluciones."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8",children:[e.jsxs(N,{className:"bg-blue-50 dark:bg-blue-900 border-blue-200 dark:border-blue-700",children:[e.jsxs(v,{children:[e.jsx(b,{className:"text-blue-800 dark:text-blue-200",children:"Fondos Retenidos"}),e.jsx(C,{className:"text-blue-600 dark:text-blue-400",children:"Dinero en custodia para contratos activos o en disputa."})]}),e.jsx(y,{children:e.jsxs("p",{className:"text-4xl font-bold text-blue-800 dark:text-blue-200",children:["$",G.toFixed(2)," USD"]})})]}),e.jsxs(N,{className:"bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700",children:[e.jsxs(v,{children:[e.jsx(b,{className:"text-green-800 dark:text-green-200",children:"Comisiones Obtenidas"}),e.jsx(C,{className:"text-green-600 dark:text-green-400",children:"Ganancias de la plataforma por servicios finalizados."})]}),e.jsx(y,{children:e.jsxs("p",{className:"text-4xl font-bold text-green-800 dark:text-green-200",children:["$",V.toFixed(2)," USD"]})})]})]}),e.jsxs("div",{className:"mb-8 p-6 border rounded-lg bg-gray-50 dark:bg-gray-700",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4 text-center",children:"Configuración de Tasa de Cambio"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4",children:[e.jsxs("div",{className:"flex-grow w-full sm:w-auto",children:[e.jsx(ae,{htmlFor:"exchange-rate",className:"sr-only",children:"Tasa Oficial (VEF/USD)"}),e.jsx(O,{id:"exchange-rate",type:"number",step:"0.01",value:D,onChange:s=>L(s.target.value),placeholder:"Ej: 36.50",className:"text-center text-lg"})]}),e.jsx(d,{onClick:Q,className:"w-full sm:w-auto",children:"Actualizar Tasa Oficial (VEF/USD)"})]}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2 text-center",children:["Tasa Oficial BCV: 1 USD = ",u.toFixed(2)," VEF"]})]}),e.jsx("h2",{className:"text-2xl font-bold mb-4 text-center",children:"Disputas Activas"}),e.jsx("div",{className:"mb-6",children:e.jsx(O,{type:"text",placeholder:"Buscar disputas por título de servicio, cliente o proveedor...",value:n,onChange:s=>z(s.target.value),className:"w-full"})}),x.length===0&&n!==""?e.jsx("p",{className:"text-center text-gray-600 dark:text-gray-400",children:"No se encontraron disputas activas que coincidan con tu búsqueda."}):x.length===0&&n===""?e.jsx("p",{className:"text-center text-gray-600 dark:text-gray-400",children:"No hay contratos en disputa actualmente."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:x.map(s=>{const a=r.get(s.clientId),t=r.get(s.providerId),c=s.serviceRate*(1-s.commissionRate);return e.jsxs(N,{className:"flex flex-col",children:[e.jsxs(v,{children:[e.jsx(b,{children:s.serviceTitle}),e.jsxs(C,{children:[e.jsx("span",{className:"font-medium",children:"ID Contrato:"})," ",s.id]})]}),e.jsxs(y,{className:"flex-grow space-y-2",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Monto en Disputa:"})," $",s.serviceRate.toFixed(2)," USD"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Cliente:"})," ",(a==null?void 0:a.name)||"Desconocido",(a==null?void 0:a.phone)&&e.jsxs("span",{className:"ml-2 text-sm text-gray-500",children:["(Tel: ",a.phone,")"]})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Proveedor:"})," ",(t==null?void 0:t.name)||"Desconocido",(t==null?void 0:t.phone)&&e.jsxs("span",{className:"ml-2 text-sm text-gray-500",children:["(Tel: ",t.phone,")"]})]}),e.jsxs("div",{className:"flex flex-col gap-2 mt-4",children:[a&&e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>F(a),children:"Chatear con Cliente"}),t&&e.jsx(d,{variant:"outline",className:"w-full",onClick:()=>F(t),children:"Chatear con Proveedor"}),e.jsxs(d,{className:"w-full bg-green-600 hover:bg-green-700 text-white",onClick:()=>J(s),children:["Liberar a Proveedor ($",c.toFixed(2),")"]}),e.jsxs(d,{className:"w-full bg-red-600 hover:bg-red-700 text-white",onClick:()=>K(s),children:["Liberar a Cliente ($",s.serviceRate.toFixed(2),")"]})]})]})]},s.id)})}),x.length<j.length&&e.jsx("div",{className:"text-center mt-6",children:e.jsxs(d,{onClick:W,variant:"outline",children:["Cargar más disputas (",j.length-x.length," restantes)"]})}),e.jsx("h2",{className:"text-2xl font-bold mt-8 mb-4 text-center",children:"Historial de Disputas Resueltas"}),m.length===0&&n!==""?e.jsx("p",{className:"text-center text-gray-600 dark:text-gray-400",children:"No se encontraron disputas resueltas que coincidan con tu búsqueda."}):m.length===0&&n===""?e.jsx("p",{className:"text-center text-gray-600 dark:text-gray-400",children:"No hay disputas resueltas aún."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:m.map(s=>{const a=r.get(s.clientId),t=r.get(s.providerId),c=s.disputeResolution==="toClient"?`Fondos liberados al Cliente ($${s.serviceRate.toFixed(2)} USD)`:`Fondos liberados al Proveedor ($${(s.serviceRate*(1-s.commissionRate)).toFixed(2)} USD)`,X=s.disputeResolution==="toClient"?"text-red-600":"text-green-600";return e.jsxs(N,{className:"flex flex-col opacity-80",children:[e.jsxs(v,{children:[e.jsx(b,{children:s.serviceTitle}),e.jsxs(C,{children:[e.jsx("span",{className:"font-medium",children:"ID Contrato:"})," ",s.id]})]}),e.jsxs(y,{className:"flex-grow space-y-2",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Monto Original:"})," $",s.serviceRate.toFixed(2)," USD"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Cliente:"})," ",(a==null?void 0:a.name)||"Desconocido"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Proveedor:"})," ",(t==null?void 0:t.name)||"Desconocido"]}),e.jsxs("p",{className:"font-medium",children:["Fecha de Resolución: ",new Date(s.updatedAt).toLocaleDateString()]}),e.jsxs("p",{className:`font-semibold ${X}`,children:["Resolución: ",c]})]})]},s.id)})}),m.length<f.length&&e.jsx("div",{className:"text-center mt-6",children:e.jsxs(d,{onClick:Y,variant:"outline",children:["Cargar más disputas (",f.length-m.length," restantes)"]})})]})}),A&&g&&e.jsx(te,{open:A,onOpenChange:E,children:e.jsxs(le,{className:"sm:max-w-[425px] md:max-w-lg lg:max-w-2xl h-[80vh] flex flex-col",children:[e.jsxs(ie,{children:[e.jsxs(ne,{children:["Chat con ",g.name," (",g.type,")"]}),e.jsx(re,{children:"Conversación de mediación para una disputa."})]}),e.jsx("div",{className:"flex-grow overflow-hidden",children:e.jsx(se,{otherUser:g,contractStatus:"disputed"})})]})}),e.jsx(R,{})]})};export{ue as default};
